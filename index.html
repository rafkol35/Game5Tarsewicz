<html>
    <head>
        <title>My first Three.js app</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>
    </head>
    <body>
        <link rel="Stylesheet" type="text/css" href="style.css" />

        <script src="js/jquery-1.10.2.min.js"></script>
        <script src="js/three.min.js"></script>
        <!--<script src="js/controls/PointerLockControls.js"></script>-->
        <script type="text/javascript" src="js/dat.gui.min.js"></script>
        <script src="js/gamemodes/gamemode.js"></script>
        <script src="js/gamemodes/gamemodeproject.js"></script>
        <script src="js/gamemodes/gamemodevisit.js"></script>
        
        <script>
            var mousePressed = false;
            var mouse = new THREE.Vector2(), INTERSECTED;
            var mouseClickPos = new THREE.Vector2();
            var mouseLast = new THREE.Vector2();
            var raycaster = new THREE.Raycaster();
            var raycasterTouch = new THREE.Raycaster();
            var walls = [];
            var controls;
            var firstMouseMove = true;
            
            //var gamemode = 0; // 0 - projektowanie 1 - zwiedzanie
            
            var gameModeProject = new GameModeProject('project');
            var gameModeVisit = new GameModeVisit('visit');
            var currentGameMode = null; //gameModeVisit; //gameModeProject;
            //setMode(gameModeVisit); // bo w egde sie nie pokaza kontrolki
            setMode(gameModeVisit);
            
            function setMode(newMode){
                if( currentGameMode !== null ) currentGameMode.deactivate();
                currentGameMode = newMode;
                if( currentGameMode !== null ) currentGameMode.activate();
            }
            
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            function onDocumentMouseDown(event) {
                event.preventDefault();

                //gamemode = (gamemode+1) % 2;
                //console.log(gamemode);
                
                //if( currentGameMode === gameModeProject ) setMode(gameModeVisit);
                //else setMode(gameModeProject);
                
                //gui.close();
                //$(gui.domElement).attr("hidden", gamemode === 0 ? true : false);
                
                mousePressed = true;
                mouseClickPos.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouseClickPos.y = -(event.clientY / window.innerHeight) * 2 + 1;
                mouseLast = mouseClickPos;

                //mousePressedPos.x = mouseClickPos.x;
                //mousePressedPos.y = mouseClickPos.y;

//                raycasterTouch.setFromCamera(mouse, camera);
//                var intersects = raycasterTouch.intersectObjects(walls);
//                if (intersects.length > 0) {
//                //    draggedCubic = intersects[0].object;
//                //    draggedCubicFaceNormal = intersects[0].face.normal.clone();
//                //    newTouchedCubic = null;
//                //    console.log("asdf");
//                }                    
            }
            
            function onDocumentMouseUp(event) {
                event.preventDefault();
                mousePressed = false;
                //draggedCubic = null;
                //newTouchedCubic = null;
                var mouseClickPos2 = new THREE.Vector2(0, 0);
                mouseClickPos2.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouseClickPos2.y = -(event.clientY / window.innerHeight) * 2 + 1;
                //var dist = mousePressedPos.distanceTo(mouseClickPos2);
                //if (dist < 0.01) {
                //    //blockOnRotate = false;
                //}
            }

            function onDocumentMouseMove(event) {
                event.preventDefault();                
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                if( firstMouseMove ){
                    firstMouseMove = false;
                    mouseLast.set(mouse.x, mouse.y);
                }
                if( currentGameMode ) currentGameMode.mouseMove(event);
                mouseLast.set(mouse.x, mouse.y);
            }
            
            var clock = new THREE.Clock();
            var deltaTime = 0.0;
             
            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            document.body.appendChild(renderer.domElement);
            document.addEventListener('mousemove', onDocumentMouseMove, false);
            document.addEventListener('mousedown', onDocumentMouseDown, false);
            document.addEventListener('mouseup', onDocumentMouseUp, false);            
            window.addEventListener('resize', onWindowResize, false);
            
            var pressedKeys = []; //new Array();
            
            var onKeyDown = function (event) {
                pressedKeys[event.keyCode] = true;
                //console.log(pressedKeys);
                if( currentGameMode ) currentGameMode.keyDown(event);
            };
            
            var onKeyUp = function (event) {
                pressedKeys[event.keyCode] = false;
                //console.log(pressedKeys);
                if( currentGameMode ) currentGameMode.keyUp(event);
            };
            
            document.addEventListener('keydown', onKeyDown, false);
            document.addEventListener('keyup', onKeyUp, false);
            
            
//            var gui = new dat.GUI({
//                height : 5 * 32 - 1
//            });
//            var params = {
//                interation: 5000
//            };
//            gui.add(params, 'interation');
            
            //gui.close();
            
            //gui.add(params, 'width').min(128).max(256).step(16);

//            var geometry = new THREE.BoxGeometry(1, 1, 1);
//            var material = new THREE.MeshBasicMaterial({color: 0x00ff00});
//            var cube = new THREE.Mesh(geometry, material);
//            scene.add(cube);
//            walls.push(cube);
//            
//            camera.position.z = 5;
////            controls = new THREE.PointerLockControls( camera );

            var render = function () {
                deltaTime = clock.getDelta();                
                requestAnimationFrame(render);
                if( currentGameMode ) currentGameMode.render(renderer);
            };

            render();
        </script>
        <div class="moveGUI">
        </div>
    </body>
</html>